KEY_FILE:= kub-deploy.json
PROJECT_ID:=absolute-text-251105
K8s_CLUSTER:=piggy-prod-jenkins
ZONE:=asia-southeast1-a

IMAGE_NAME:=gcr.io/absolute-text-251105/piggy1-user
IMAGE_VERSION:=v4

gauth:
	@gcloud auth activate-service-account --key-file ${KEY_FILE}

gconfig:
	@gcloud config set project $(PROJECT_ID)
	@gcloud container clusters get-credentials $(K8s_CLUSTER) --zone $(ZONE) --project $(PROJECT_ID)
	@gcloud auth configure-docker

build:
	@docker tag user-prod gcr.io/$(PROJECT_ID)/$(IMAGE_NAME):$(IMAGE_VERSION)
	
push:
	@docker push gcr.io/$(PROJECT_ID)/$(IMAGE_NAME):$(IMAGE_VERSION)

deploy: gconfig
	@kubectl apply -f k8s/canary/user-deployment.yaml -n production
# https://github.com/kubernetes/kubernetes/issues/27081#issuecomment-238078103
	@kubectl patch deployment $(IMAGE_NAME) -n production -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"date\":\"`date +'%s'`\"}}}}}"